<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>التحقق من النتيجة</title>
  <style>
    body{font-family:Tahoma,Arial; margin:24px}
    .box{max-width:860px; margin:auto; border:1px solid #ddd; padding:16px; border-radius:12px}
    input,button{font-size:16px; padding:10px; width:100%; margin-top:10px}
    button{cursor:pointer}
    .muted{color:#666; font-size:14px}
    .bad{color:#b00020; font-weight:bold}
    .ok{color:green; font-weight:bold}
    .warn{color:#a15c00; font-weight:bold}

    .modal-bg{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:14px}
    .modal{background:#fff; border-radius:12px; max-width:1100px; width:100%; padding:16px; max-height:92vh; overflow:auto}
    .head{display:flex; gap:10px; align-items:flex-start; justify-content:space-between}
    .title h2{margin:0 0 4px}
    .title .sub{margin:0; color:#444}
    .pill{padding:6px 10px; border-radius:999px; background:#f3f3f3; font-size:14px; display:inline-block}
    .pillRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start; align-items:center}
    .pill.bad{background:#ffe8ea; color:#b00020; font-weight:bold}
    .pill.ok{background:#e8fff0; color:#0b6b3a; font-weight:bold}
    .pill.warn{background:#fff2e1; color:#a15c00; font-weight:bold}

    table{width:100%; border-collapse:collapse; margin-top:12px}
    th,td{border:1px solid #ddd; padding:8px; text-align:center; font-size:14px}
    th{background:#f7f7f7}
    .subject{ text-align:right; white-space:nowrap }

    .sectionTitle{margin:16px 0 6px; font-weight:bold}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="box">
    <h2>التحقق من النتيجة</h2>
    <p class="muted">امسح QR من الورقة، ثم أدخل PIN الموجود أسفل الورقة لعرض جدول الدرجات.</p>

    <input id="pin" inputmode="numeric" placeholder="PIN" />
    <button id="btn">تحقق</button>
    <div id="msg"></div>
  </div>

  <div id="modalBg" class="modal-bg">
    <div class="modal">
      <div class="head">
        <div class="title">
          <h2 id="mSchool">—</h2>
          <p id="mPrincipal" class="sub">—</p>
          <p id="mStudent" class="sub">—</p>
        </div>
        <div style="min-width:280px">
          <div class="pillRow">
            <div id="mOverall" class="pill">—</div>
            <div id="mPeriod" class="pill">—</div>
          </div>
          <button style="margin-top:10px" onclick="closeModal()">إغلاق</button>
        </div>
      </div>

      <div class="sectionTitle">جدول الدرجات</div>
      <table>
        <thead>
          <tr>
            <th>المادة</th>
            <th>الفصل الأول</th>
            <th>نصف السنة</th>
            <th>الفصل الثاني</th>
            <th>السعي السنوي</th>
            <th>الامتحان النهائي</th>
            <th>الدرجة النهائية (د1)</th>
            <th>امتحان الدور الثاني</th>
            <th>الدرجة النهائية (د2)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div id="d2Wrap" class="hide">
        <div class="sectionTitle">جدول درجات الدور الثاني</div>
        <table>
          <thead>
            <tr>
              <th>المادة</th>
              <th>امتحان الدور الثاني</th>
              <th>الدرجة النهائية (د2)</th>
            </tr>
          </thead>
          <tbody id="tbodyD2"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ✅ المستخرج من كودك القديم
    const API_URL = "https://verify-asmaa-worker.sameralsaady.workers.dev/verify";

    function closeModal(){ document.getElementById("modalBg").style.display = "none"; }

    function qs(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }

    function firstNonEmpty(obj, keys){
      for (const k of keys){
        const v = obj ? obj[k] : undefined;
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
      return "";
    }

    function setPill(el, text){
      el.textContent = text || "—";
      el.className = "pill";
      const t = (text || "").trim();
      if (!t) return;

      if (t.includes("مكمل") || t.includes("راسب")) el.classList.add("bad");
      else if (t.includes("بقرار")) el.classList.add("warn");
      else if (t.includes("ناجح")) el.classList.add("ok");
    }

    function isDecisionValue(v){
      const s = String(v ?? "");
      return s.includes("(50)") || s.includes("（50）");
    }

    function numFrom(v){
      if (v === null || v === undefined) return null;
      const s = String(v).trim();
      if (!s) return null;
      const cleaned = s.replace(/\u0336/g, "");
      const m = cleaned.match(/(\d+(\.\d+)?)/);
      if (!m) return null;
      const n = parseFloat(m[1]);
      return Number.isFinite(n) ? n : null;
    }

    // ✅ اكتشاف “الفترة المُعلنة” من الـ rows فقط (بدون مفاتيح جديدة)
    function detectAnnouncedPeriod(rows){
      const has = (k) => (rows || []).some(r => String(r?.[k] ?? "").trim() !== "");
      if (has("final1")) return { label: "نتيجة الدرجة النهائية", key: "final1" };
      if (has("final_exam")) return { label: "نتيجة الامتحان النهائي", key: "final_exam" };
      if (has("effort")) return { label: "نتيجة السعي السنوي", key: "effort" };
      if (has("t2")) return { label: "نتيجة الفصل الثاني", key: "t2" };
      if (has("mid")) return { label: "نتيجة نصف السنة", key: "mid" };
      if (has("t1")) return { label: "نتيجة الفصل الأول", key: "t1" };
      return { label: "نتيجة الفترة", key: "" };
    }

    function computePeriodOverall(rows, key){
      if (!key) return "—";
      let hasAny=false, hasFail=false, hasDecision=false;

      for (const r of (rows || [])){
        const subj = String(r?.subject ?? "").trim();
        if (!subj) continue;

        const sv = String(r?.[key] ?? "").trim();
        if (!sv) continue;

        hasAny = true;
        if (isDecisionValue(sv)) hasDecision = true;

        const n = numFrom(sv);
        if (n !== null && n < 50 && !isDecisionValue(sv)) hasFail = true;
      }

      if (!hasAny) return "—";
      if (hasFail) return "مكمل";
      if (hasDecision) return "ناجح بقرار";
      return "ناجح";
    }

    function renderRows(rows){
      const tb = document.getElementById("tbody");
      tb.innerHTML = "";
      for(const r of (rows || [])){
        const tr = document.createElement("tr");
        const cells = [
          ["subject", "subject"],
          ["t1", ""],
          ["mid", ""],
          ["t2", ""],
          ["effort", ""],
          ["final_exam", ""],
          ["final1", ""],
          ["d2_exam", ""],
          ["final2", ""],
        ];
        for(const [k, cls] of cells){
          const td = document.createElement("td");
          td.textContent = (r?.[k] ?? "");
          if(cls) td.className = cls;
          tr.appendChild(td);
        }
        tb.appendChild(tr);
      }
    }

    // ✅ جدول الدور الثاني: أولاً من مفاتيح الووركر إن وجدت، وإلا نشتقه من rows
    function getMakeupRows(data){
      const v = firstNonEmpty(data, ["makeup_rows","makeupRows","d2_rows","second_round","makeup"]);
      if (Array.isArray(v)) return v;
      try{
        const j = JSON.parse(v);
        if (Array.isArray(j)) return j;
      }catch(e){}
      return [];
    }

    function renderD2Rows(makeupRows){
      const wrap = document.getElementById("d2Wrap");
      const tb = document.getElementById("tbodyD2");
      tb.innerHTML = "";

      if (!makeupRows || !makeupRows.length){
        wrap.classList.add("hide");
        return false;
      }

      for(const r of makeupRows){
        let subj="", d2="", f2="";
        if (Array.isArray(r)){
          subj = r[0] ?? "";
          d2   = r[1] ?? "";
          f2   = r[2] ?? "";
        } else {
          subj = r.subject || r.subj || r.material || "";
          d2   = r.d2_exam || r.d2 || r.second || "";
          f2   = r.final2 || r.f2 || r.final_second || "";
        }
        const tr = document.createElement("tr");
        const td1 = document.createElement("td"); td1.textContent = subj; td1.className="subject";
        const td2 = document.createElement("td"); td2.textContent = d2;
        const td3 = document.createElement("td"); td3.textContent = f2;
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
        tb.appendChild(tr);
      }

      wrap.classList.remove("hide");
      return true;
    }

    function renderD2FromRows(rows){
      const wrap = document.getElementById("d2Wrap");
      const tb = document.getElementById("tbodyD2");
      tb.innerHTML = "";

      const d2Rows = (rows || []).filter(r => {
        const d2 = String(r?.d2_exam ?? "").trim();
        const f2 = String(r?.final2 ?? "").trim();
        return d2 !== "" || f2 !== "";
      });

      if (!d2Rows.length){
        wrap.classList.add("hide");
        return;
      }

      for (const r of d2Rows){
        const tr = document.createElement("tr");
        const td1 = document.createElement("td"); td1.textContent = r?.subject ?? ""; td1.className="subject";
        const td2 = document.createElement("td"); td2.textContent = r?.d2_exam ?? "";
        const td3 = document.createElement("td"); td3.textContent = r?.final2 ?? "";
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
        tb.appendChild(tr);
      }

      wrap.classList.remove("hide");
    }

    function openModal(data){
      document.getElementById("mSchool").textContent = data.school || "—";
      document.getElementById("mPrincipal").textContent = "المديرة: " + (data.principal || "—");
      document.getElementById("mStudent").textContent =
        `الطالب: ${data.student} — الصف: ${data.grade} — الشعبة: ${data.section} — العام الدراسي: ${data.academic_year || ""}`;

      setPill(document.getElementById("mOverall"), "النتيجة النهائية: " + (data.overall || "—"));

      const rows = data.rows || [];
      renderRows(rows);

      // ✅ نتيجة الفترة: إن أرجعها الووركر نستخدمها، وإلا نحسبها
      const pLabel = firstNonEmpty(data, ["period_label","periodLabel","period","periodName"]);
      const pOv    = firstNonEmpty(data, ["period_overall","periodOverall","period_result","periodResult","periodStatus"]);
      if (String(pLabel||"").trim() && String(pOv||"").trim()){
        setPill(document.getElementById("mPeriod"), `${pLabel}: ${pOv}`);
      } else {
        const p = detectAnnouncedPeriod(rows);
        const pov = computePeriodOverall(rows, p.key);
        setPill(document.getElementById("mPeriod"), `${p.label}: ${pov}`);
      }

      // ✅ جدول الدور الثاني: إذا الووركر أرسله نعرضه، وإلا نشتقه من rows
      const mk = getMakeupRows(data);
      const shown = renderD2Rows(mk);
      if (!shown) renderD2FromRows(rows);

      document.getElementById("modalBg").style.display = "flex";
    }

    document.getElementById("btn").addEventListener("click", async () => {
      const pin = document.getElementById("pin").value.trim();
      const token = qs("t");
      const msg = document.getElementById("msg");
      msg.textContent = "";
      msg.className = "";

      if(!token){
        msg.textContent = "الرابط لا يحتوي Token. امسح QR الصحيح من الورقة.";
        msg.className = "bad";
        return;
      }
      if(pin.length < 4){
        msg.textContent = "أدخل PIN صحيح.";
        msg.className = "bad";
        return;
      }

      try{
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ token, pin })
        });
        const data = await resp.json();
        if(!data || !data.ok){
          msg.textContent = (data && data.error) ? data.error : "PIN غير صحيح أو نتيجة غير موجودة.";
          msg.className = "bad";
          return;
        }
        openModal(data);
      }catch(e){
        msg.textContent = "تعذر الاتصال بخدمة التحقق.";
        msg.className = "bad";
      }
    });
  </script>
</body>
</html>
