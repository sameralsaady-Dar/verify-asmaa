<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>التحقق من النتيجة</title>
  <style>
    body{font-family:Tahoma,Arial; margin:24px}
    .box{max-width:860px; margin:auto; border:1px solid #ddd; padding:16px; border-radius:12px}
    input,button{font-size:16px; padding:10px; width:100%; margin-top:10px}
    button{cursor:pointer}
    .muted{color:#666; font-size:14px}
    .bad{color:#b00020; font-weight:bold}
    .ok{color:green; font-weight:bold}

    .modal-bg{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:14px}
    .modal{background:#fff; border-radius:12px; max-width:1100px; width:100%; padding:16px; max-height:92vh; overflow:auto}
    .head{display:flex; gap:10px; align-items:flex-start; justify-content:space-between}
    .title h2{margin:0 0 4px}
    .title .sub{margin:0; color:#444}

    table{width:100%; border-collapse:collapse; margin-top:12px}
    th,td{border:1px solid #ddd; padding:8px; text-align:center; font-size:14px}
    th{background:#f7f7f7}
    .subject{text-align:right; white-space:nowrap}

    .sectionTitle{margin:16px 0 6px; font-weight:bold}
    .hide{display:none}
    s{opacity:.75}
  </style>
</head>
<body>

  <div class="box">
    <h2>التحقق من النتيجة</h2>
    <p class="muted">امسح QR من الورقة، ثم أدخل PIN الموجود أسفل الورقة لعرض جدول الدرجات.</p>

    <input id="pin" inputmode="numeric" placeholder="PIN" />
    <button id="btn">تحقق</button>
    <div id="msg"></div>
  </div>

  <div id="modalBg" class="modal-bg">
    <div class="modal" id="modal">
      <div class="head">
        <div class="title">
          <h2 id="mSchool">—</h2>
          <p id="mPrincipal" class="sub">—</p>
          <p id="mStudent" class="sub">—</p>
        </div>
      </div>

      <div class="sectionTitle">جدول الدرجات</div>
      <table>
        <thead>
          <tr>
            <th>المادة</th>
            <th>الفصل الأول</th>
            <th>نصف السنة</th>
            <th>الفصل الثاني</th>
            <th>السعي السنوي</th>
            <th>الامتحان النهائي</th>
            <th>الدرجة النهائية (د1)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div id="d2Wrap" class="hide">
        <div class="sectionTitle">جدول درجات الدور الثاني</div>
        <table>
          <thead>
            <tr>
              <th>المادة</th>
              <th>امتحان الدور الثاني</th>
              <th>الدرجة النهائية (د2)</th>
            </tr>
          </thead>
          <tbody id="tbodyD2"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://verify-asmaa-worker.sameralsaady.workers.dev/verify";

  function closeModal(){
    document.getElementById("modalBg").style.display = "none";
  }

  document.getElementById("modalBg").addEventListener("click", (e)=>{
    if (e.target.id === "modalBg") closeModal();
  });
  document.getElementById("modal").addEventListener("click", (e)=> e.stopPropagation());
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });

  function qs(name){
    return new URL(location.href).searchParams.get(name) || "";
  }

  function cleanText(v){
    if(v === null || v === undefined) return "";
    return String(v).replace(/\u0336/g,"").replace(/\s+/g," ").trim();
  }

  function parseStrike(v){
    if(!v || !String(v).includes("\u0336")) return null;
    const raw = String(v).replace(/\u0336/g,"");
    const m = raw.match(/^(\d+)/);
    if(!m) return null;
    return { old:m[1], rest:raw.slice(m[1].length).trim() };
  }

  function setCell(td, v){
    const p = parseStrike(v);
    if(p){
      td.innerHTML = `<s>${p.old}</s>${p.rest ? " "+p.rest : ""}`;
    }else{
      td.textContent = cleanText(v);
    }
  }

  function renderRows(rows){
    const tb = document.getElementById("tbody");
    tb.innerHTML = "";
    for(const r of (rows||[])){
      const tr = document.createElement("tr");
      const cols = ["subject","t1","mid","t2","effort","final_exam","final1"];
      for(const k of cols){
        const td = document.createElement("td");
        if(k==="subject") td.className="subject";
        setCell(td, r[k]);
        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }
  }

  function renderD2(rows){
    const wrap = document.getElementById("d2Wrap");
    const tb = document.getElementById("tbodyD2");
    tb.innerHTML = "";

    const d2rows = (rows||[]).filter(r =>
      String(r?.d2_exam||"").trim() || String(r?.final2||"").trim()
    );

    if(!d2rows.length){
      wrap.classList.add("hide");
      return;
    }

    for(const r of d2rows){
      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.className="subject"; setCell(td1, r.subject);
      const td2 = document.createElement("td"); setCell(td2, r.d2_exam);
      const td3 = document.createElement("td"); setCell(td3, r.final2);
      tr.append(td1,td2,td3);
      tb.appendChild(tr);
    }
    wrap.classList.remove("hide");
  }

  function openModal(data){
    document.getElementById("mSchool").textContent = data.school || "—";
    document.getElementById("mPrincipal").textContent = "المديرة: " + (data.principal||"—");
    document.getElementById("mStudent").textContent =
      `الطالب: ${data.student} — الصف: ${data.grade} — الشعبة: ${data.section} — العام الدراسي: ${data.academic_year||""}`;

    const rows = data.rows || [];
    renderRows(rows);
    renderD2(rows);

    document.getElementById("modalBg").style.display = "flex";
  }

  document.getElementById("btn").addEventListener("click", async ()=>{
    const pin = document.getElementById("pin").value.trim();
    const token = qs("t");
    const msg = document.getElementById("msg");
    msg.textContent=""; msg.className="";

    if(!token){ msg.textContent="الرابط لا يحتوي Token."; msg.className="bad"; return; }
    if(pin.length<4){ msg.textContent="أدخل PIN صحيح."; msg.className="bad"; return; }

    try{
      const r = await fetch(API_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ token, pin })
      });
      const data = await r.json();
      if(!data || !data.ok){
        msg.textContent = data?.error || "PIN غير صحيح.";
        msg.className="bad";
        return;
      }
      openModal(data);
    }catch{
      msg.textContent="تعذر الاتصال بخدمة التحقق.";
      msg.className="bad";
    }
  });
</script>
</body>
</html>
